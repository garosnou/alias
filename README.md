# Alias Game - Документация по логике работы

## Обзор игры

Alias - это игра в слова, где игроки объясняют слова своей команде за ограниченное время. Игра поддерживает как обычный режим, так и турнирный режим с несколькими командами.

## Основные режимы игры

### 1. Обычная игра (Single Player)
- Один игрок объясняет слова своей команде
- Настраиваемое время (30-120 секунд)
- Настраиваемое количество слов (10-50)
- Выбор категории слов
- Источник слов: встроенная база или пользовательский пакет

### 2. Турнирный режим
- До 8 команд
- Настраиваемое количество игроков в команде
- Два режима игры:
  - **Sequential (Последовательный)**: сначала все игроки команды 1, затем все игроки команды 2
  - **Alternating (Чередующийся)**: игроки команд играют через одного

## Архитектура и состояние игры

### Основные объекты состояния

#### `gameState` - состояние текущей игры
```javascript
{
    isPlaying: boolean,        // Игра активна
    isPaused: boolean,         // Игра на паузе
    score: number,             // Текущий счет
    correctAnswers: number,    // Количество правильных ответов
    skippedWords: number,      // Количество пропущенных слов
    currentWord: string,       // Текущее слово
    correctWords: Array,       // Массив отгаданных слов
    skippedWordsList: Array,   // Массив пропущенных слов
    startTime: number,         // Время начала игры
    timeLimit: number,         // Лимит времени
    totalWords: number,        // Общее количество слов
    category: string,          // Категория слов
    timerInterval: number      // ID интервала таймера
}
```

#### `tournamentState` - состояние турнира
```javascript
{
    isTournamentMode: boolean,           // Турнирный режим активен
    teams: Array,                       // Массив команд
    matches: Array,                     // Массив матчей
    currentRound: number,               // Текущий раунд
    currentMatch: number,               // Текущий матч
    currentTeamIndex: number,           // Индекс текущей команды (0 или 1)
    currentPlayerIndex: number,         // Индекс текущего игрока
    matchScores: Array,                 // Счет матча [команда1, команда2]
    tournamentScores: Array,             // Общий счет турнира
    maxRounds: number,                  // Максимум раундов
    gameMode: string,                   // 'sequential' | 'alternating'
    currentMatchPlayerResults: Array,   // Детальные результаты игроков текущего матча
    isOvertime: boolean,                // Дополнительный раунд при ничьей
    overtimePlayers: Array             // Игроки для дополнительного раунда
}
```

#### `settings` - настройки игры
```javascript
{
    timeLimit: number,          // Лимит времени
    wordCount: number,          // Количество слов
    category: string,           // Категория
    wordSource: string         // 'builtin' | 'custom'
}
```

## Логика турнирного режима

### Структура матчей
Матчи хранятся в `tournamentState.matches`:
```javascript
{
    round: number,              // Номер раунда
    team1: number | {from: number},  // Команда 1 (индекс или ссылка на победителя)
    team2: number | {from: number},  // Команда 2 (индекс или ссылка на победителя)
    winner: number | null       // Победитель (индекс команды)
}
```

### Разрешение команд
Функция `getResolvedTeamIds(match)` разрешает ссылки на команды:
- Если `team1/team2` - число → возвращает как есть
- Если `team1/team2` - объект `{from: matchIndex}` → находит победителя этого матча

### Режимы игры в турнире

#### Sequential (Последовательный)
1. Все игроки команды 1 играют по очереди
2. Затем все игроки команды 2 играют по очереди
3. Матч завершается после последнего игрока команды 2

#### Alternating (Чередующийся)
1. Игроки команд играют через одного: К1-И1, К2-И1, К1-И2, К2-И2, ...
2. Количество ходов = `min(игроков_в_команде1, игроков_в_команде2) * 2`
3. Матч завершается после последнего хода

### Турнирная сетка
- Если команд ≤ 3: играют все против всех
- Если команд > 3: создается турнирная сетка
- Победители матчей автоматически продвигаются в следующие раунды

## Управление словами

### Источники слов
1. **Встроенная база** (`WORDS_DATABASE`): категории из `words.js`
2. **Пользовательский пакет**: загружается из файла `.txt`

### Предотвращение повторений в пользовательских пакетах
```javascript
let CUSTOM_WORDS_META = { fileName: null, usedCount: 0, total: 0 };
let CUSTOM_WORDS_USED = new Set(); // Множество использованных слов
```

### Функция `getWordsForCurrentSource()`
- Фильтрует уже использованные слова из пользовательских пакетов
- Возвращает случайные неиспользованные слова
- НЕ помечает слова как использованные (это делается после игры)

### Функция `markWordsAsUsed()`
- Вызывается после завершения игры
- Добавляет только те слова, которые игрок действительно видел (до `currentWordIndex`)
- Неиспользованные слова возвращаются в игру
- Сохраняет состояние в localStorage
- Обновляет UI с новым количеством оставшихся слов

## Ключевые функции

### Игровой цикл
- `startGame()` - начало игры
- `endGame()` - завершение игры (проверяет турнирный режим)
- `endTournamentGame()` - завершение в турнирном режиме
- `endPlayerGame()` - завершение хода игрока в турнире

### Турнирные функции
- `startTournament()` - начало турнира
- `generateTournamentBracket()` - создание турнирной сетки
- `startTournamentMatch()` - начало матча
- `endMatch()` - завершение матча
- `isMatchComplete()` - проверка завершения матча
- `startOvertime()` - начало дополнительного раунда при ничьей
- `updateMatchScore()` - обновление отображения счета

### Управление состоянием
- `updateCurrentPlayerInfo()` - обновление информации о текущем игроке
- `showScreen(screenName)` - переключение экранов
- `saveSettings()` / `loadSettings()` - сохранение/загрузка настроек

## Особенности реализации

### Обработка матчей победителей
В финальных матчах команды определяются как `{from: matchIndex}`. Функция `getResolvedTeamIds()` разрешает эти ссылки, находя реальных победителей предыдущих матчей.

### Сохранение результатов игроков
В `tournamentState.currentMatchPlayerResults` сохраняются детальные результаты каждого игрока:
```javascript
{
    teamIndex: number,
    teamName: string,
    playerIndex: number,
    playerName: string,
    score: number,
    correctWords: Array,
    skippedWords: Array
}
```

### Экспорт результатов
Функция `exportMatchResults()` создает `.txt` файл с детальными результатами матча, включая слова каждого игрока.

### Информационная панель
`updateMainInfoBanner()` показывает:
- Режим игры (стандартный/пользовательский)
- Статус пользовательского пакета
- Количество неиспользованных слов

## Локальное хранилище

### Ключи localStorage
- `alias-settings` - настройки игры
- `alias-history` - история игр
- `alias-custom-words` - пользовательские слова
- `alias-custom-words-meta` - метаданные пакета
- `alias-custom-words-used` - использованные слова


## Важные моменты

1. **Завершение матчей**: Матч завершается только после того, как все игроки обеих команд сыграли
2. **Счет команд**: Очки начисляются команде, а не отдельному игроку
3. **Время игры**: В турнире используется глобальное время из настроек
4. **Категории**: В турнире используются глобальные настройки категории
5. **Повторения слов**: В пользовательских пакетах слова не повторяются до смены пакета. Встроенные слова могут повторяться между играми

## Отладка

### Частые проблемы
1. **Раннее завершение матчей**: Проверить логику в `isMatchComplete()`
2. **Неправильный счет**: Проверить `teamIndex` в `endPlayerGame()`
3. **Проблемы с командами**: Проверить `getResolvedTeamIds()`
4. **Повторения слов**: Проверить `CUSTOM_WORDS_USED` и `getWordsForCurrentSource()`

### Логирование
Добавить `console.log()` в ключевые функции для отладки:
- `endPlayerGame()` - для отслеживания переходов между игроками
- `isMatchComplete()` - для проверки логики завершения
- `getResolvedTeamIds()` - для проверки разрешения команд
